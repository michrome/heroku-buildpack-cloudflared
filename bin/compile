#!/bin/sh

build_dir=$1
working_dir=`pwd`

# Download cloudflared. It will be at /app/vendor/cloudflared on dyno
wget -q https://bin.equinox.io/c/VdrWdbjqyF/cloudflared-stable-linux-amd64.tgz
mkdir -p $build_dir/vendor
tar -C $build_dir/vendor -xzf cloudflared-stable-linux-amd64.tgz
#Â Add cloudflared to PATH
mkdir -p $build_dir/.profile.d
echo 'PATH=$PATH:$HOME/vendor' > $build_dir/.profile.d/cloudflared.sh
# Pull config from ENV
mkdir -p $build_dir/.cloudflared
printf "%s\n" "$TUNNEL_CERT" > $build_dir/.cloudflared/cert.pem
echo "Created cert from TUNNEL_CERT env"
printf "%s\n" "$TUNNEL_CONFIG" > $build_dir/.cloudflared/${MY_TUNNEL}.json
echo "Created credentials-file ${MY_TUNNEL}.json from TUNNEL_CONFIG env"
